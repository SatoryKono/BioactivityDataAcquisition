flowchart TD
    Start([Start molecule_chembl run]) --> Extract[Extract molecule chunks (id_only/api/csv)]
    Extract --> Transform[Transform & normalize]
    Transform --> Validate[Validate with Pandera schema]
    Validate --> Decision{Dry run?}
    Decision -- No --> Write[Stable sort + write outputs]
    Write --> Meta[Generate meta.yaml + QC]
    Decision -- Yes --> SkipWrite[Skip write; produce summary]
    Meta --> End([Success])
    SkipWrite --> End
    Extract -->|Error| Retry{Retry/Skip/Fail per policy}
    Retry --> Extract
    Retry --> End

