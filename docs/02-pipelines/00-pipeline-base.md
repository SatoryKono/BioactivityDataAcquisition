# 00 Pipeline Base

## Описание

PipelineBase — абстрактный базовый класс табличного ETL-пайплайна. Оркестрирует стадии extract-transform-validate-write, обеспечивая единый интерфейс, логирование, валидацию (через Pandera) и атомарную запись результатов. Также централизованно управляет ресурсами (например, закрывает подключения) и поддерживает dry_run режим без записи.

Пайплайн обеспечивает детерминированное выполнение: фиксированный порядок колонок/строк, UTC-время, каноническая сериализация. Результаты записываются атомарно (temp → os.replace) для обеспечения целостности данных.

## Модуль

`src/bioetl/core/pipeline/unified.py`

## Основные методы

### `extract(self, descriptor: Any, options: StageExecutionOptions) -> pd.DataFrame`

**Абстрактный** метод извлечения данных (реализуется в подклассах).

**Параметры:**
- `descriptor` — дескриптор извлечения данных
- `options` — опции выполнения стадии

**Возвращает:** DataFrame с извлечёнными данными.

### `transform(self, df: pd.DataFrame, options: StageExecutionOptions) -> pd.DataFrame`

**Абстрактный** метод трансформации данных (реализуется в подклассах).

**Параметры:**
- `df` — DataFrame для трансформации
- `options` — опции выполнения стадии

**Возвращает:** трансформированный DataFrame.

### `validate(self, df: pd.DataFrame, options: StageExecutionOptions) -> pd.DataFrame`

Выполняет валидацию DataFrame, если включена (вызывает Pandera-валидатор через ValidationService).

**Параметры:**
- `df` — DataFrame для валидации
- `options` — опции выполнения стадии

**Возвращает:** валидированный DataFrame.

### `save_results(self, df: pd.DataFrame, artifacts: WriteArtifacts, options: StageExecutionOptions) -> WriteResult`

Сохраняет DataFrame, используя `write_service` (если не настроен, бросает исключение).

**Параметры:**
- `df` — DataFrame для сохранения
- `artifacts` — объект `WriteArtifacts` с путями к артефактам
- `options` — опции выполнения стадии

**Возвращает:** `WriteResult` с информацией о записанных файлах.

### `prepare_run(self, options: StageExecutionOptions) -> None`

Опциональный хук, вызывается перед началом стадии extract (умолчание – ничего не делает).

**Параметры:**
- `options` — опции выполнения стадии

### `finalize_run(self, run_result: RunResult) -> None`

Опциональный хук, вызывается после завершения стадии записи (умолчание – ничего не делает).

**Параметры:**
- `run_result` — результат выполнения пайплайна

### `build_stage_plan(self, context: StageContext, options: StageExecutionOptions) -> tuple[StageDescriptor, ...]`

Формирует план выполнения стадий по умолчанию (extract→transform→validate→save), учитывая настройки (dry_run, наличие валидатора и пр.).

**Параметры:**
- `context` — контекст выполнения стадий
- `options` — опции выполнения стадии

**Возвращает:** кортеж дескрипторов стадий.

## Функциональность

- **Единый интерфейс**: стандартизированный способ выполнения ETL-пайплайнов
- **Логирование**: интеграция с LoggerAdapterABC для структурированного логирования событий
- **Валидация**: автоматическая проверка данных по Pandera-схемам перед записью
- **Атомарная запись**: гарантия целостности данных через временные файлы
- **Управление ресурсами**: автоматическое закрытие подключений и освобождение ресурсов стадий
- **Dry-run режим**: возможность тестирования без записи результатов

## Управление ресурсами

Пайплайн централизованно управляет жизненным циклом ресурсов:
- Вызывает `dispose()` на всех стадиях после завершения
- Закрывает подключения к внешним источникам данных
- Освобождает кэши и временные ресурсы
- Гарантирует корректное завершение даже при ошибках

## Related Components

- **StageABC**: стадии пайплайна (extract, transform, validate, write)
- **PipelineHookABC**: хуки для мониторинга выполнения
- **ErrorPolicyABC**: политика обработки ошибок
- **LoggerAdapterABC**: структурированное логирование
- **SchemaProviderABC**: поставка схем для валидации
- **WriterABC**: запись результатов в хранилище

