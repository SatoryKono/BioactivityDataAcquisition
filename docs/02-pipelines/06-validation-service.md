# 06 Validation Service

## Описание

`DefaultValidationService` — сервис валидации данных пайплайна по схеме. Обёртка вокруг Pandera-схемы, используемая для проверки соответствия DataFrame ожидаемому формату и для выдачи пустого DataFrame при необходимости. В данном пайплайне применяется, например, для возвращения пустого результата, если стратегия извлечения ничего не вернула, либо для предупреждения о дрейфе схемы (может подавлять исключения схемы).

## Модуль

`src/bioetl/core/pipeline/services/defaults.py`

## Основные методы

### `empty_frame(self) -> pd.DataFrame`

Возвращает пустой DataFrame согласно схеме – со всеми требуемыми колонками, но без строк.

**Использование:**
- Используется стратегиями извлечения как запасной результат в случае отсутствия данных
- Обеспечивает корректную структуру DataFrame даже при отсутствии данных

**Возвращает:** пустой DataFrame с колонками согласно схеме.

### `validate(self, df: pd.DataFrame, *, pipeline: PipelineBaseProtocol, options: StageExecutionOptions) -> pd.DataFrame`

Валидирует DataFrame с помощью Pandera-схемы (`self.validator.validate(df)`) и затем сортирует колонки и строки для стабильности результата.

**Параметры:**
- `df` — DataFrame для валидации
- `pipeline` — протокол пайплайна (игнорируется)
- `options` — опции выполнения стадии (игнорируются)

**Процесс валидации:**

1. Проверка схемы: валидация DataFrame по Pandera-схеме через `self.validator.validate(df)`
2. Сортировка столбцов: упорядочивание столбцов для детерминизма
3. Сортировка строк: упорядочивание строк для стабильности результата
4. Обработка ошибок: выбрасывание ошибки при несовпадении или предупреждение при разрешённом дрейфе схемы
5. Возврат результата: возврат отсортированного DataFrame при успешной валидации

**Возвращает:** валидированный и отсортированный DataFrame.

**Обработка дрейфа схемы:**

- Если дрейф схемы разрешён, сервис может предупреждать о несовпадениях, но не прерывать выполнение
- Если дрейф схемы запрещён, выбрасывается исключение при несовпадении

## Использование

Сервис используется внутри `UnifiedOutputWriter` через метод `validate_with_schema` для валидации данных перед записью.

## Related Components

- **UnifiedOutputWriter**: использует сервис для валидации данных (см. `docs/02-pipelines/core/04-unified-output-writer.md`)
- **SchemaRegistry**: предоставляет схемы для валидации (см. `docs/02-pipelines/core/05-schema-registry.md`)
- **ChEMBLActivitySchema**: Pandera-схема для валидации данных активности (см. `docs/02-pipelines/chembl/activity/12-activity-chembl-schema.md`)

