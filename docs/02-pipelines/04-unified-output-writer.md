# 04 Unified Output Writer

## Описание

`UnifiedOutputWriter` — унифицированный компонент для записи результатов пайплайнов. Обеспечивает атомарную запись DataFrame на диск с полным набором артефактов: данные в различных форматах (CSV/Parquet), метаданные (YAML-файл `meta.yaml` с информацией о релизе, версии и т.д.) и JSON-манифест (`run_manifest.json` с путями и метаданными), а также генерацию QC-отчётов.

Компонент гарантирует детерминированную запись: фиксированный порядок колонок, стабильная сортировка, атомарные операции записи (temp → os.replace).

## Модуль

`src/bioetl/core/io/output.py`

## Основные возможности

- **Атомарная запись**: использование временных файлов и `os.replace` для гарантии целостности
- **Множественные форматы**: поддержка CSV и Parquet
- **Метаданные**: автоматическая генерация `meta.yaml` с информацией о пайплайне, релизе, количестве записей
- **Манифест**: создание JSON-манифеста с путями к артефактам
- **QC-отчёты**: генерация отчётов о качестве данных
- **Детерминизм**: фиксированный порядок колонок и строк, каноническая сериализация

## Основной метод

### `write_dataset_atomic(self, df: pd.DataFrame, artifacts: RunArtifacts, *, format="csv", output_format=None, encoding="utf-8", index=False) -> WriteResult`

Выполняет атомарную запись датасета с полным набором артефактов.

**Параметры:**
- `df` — DataFrame для записи
- `artifacts` — объект `RunArtifacts` с путями для `data_path`, `meta_path`, `manifest_path`
- `format` — формат данных (`"csv"` или `"parquet"`)
- `output_format` — опциональный формат вывода (если отличается от `format`)
- `encoding` — кодировка для текстовых файлов (по умолчанию `"utf-8"`)
- `index` — записывать ли индекс DataFrame

**Процесс записи:**

1. Регистрация путей: регистрация путей для `data_path`, `meta_path` и `manifest_path` в `WriteArtifacts`
2. Создание директории: создание целевой директории для артефактов
3. Валидация данных: валидация DataFrame по зарегистрированной схеме из `SchemaRegistry`
4. Сортировка DataFrame: упорядочивание строк по ключам сортировки для детерминизма
5. Запись данных: атомарная запись DataFrame во временный файл и перемещение как `<run_stem>.csv` или `.parquet`
6. Вычисление хешей: расчёт хешей содержимого файлов для проверки целостности
7. Генерация метаданных: формирование структуры метаданных через `build_meta_yaml` и атомарная запись через `write_yaml_atomic`
8. Расчёт бизнес-ключей: вычисление бизнес-ключей и хешей строк для дедупликации
9. Создание манифеста: генерация JSON-манифеста с хешами, размерами файлов и метаданными
10. Сохранение манифеста: запись JSON-манифеста в файл

**Возвращает:** `WriteResult` с информацией о записанных файлах и метриках.

## Атомарная запись

Все операции записи выполняются атомарно:

```python
# Пример атомарной записи CSV
tmp_path = data_path.with_suffix(".tmp")
df.to_csv(tmp_path, encoding=encoding, index=index)
os.replace(tmp_path, data_path)
```

Это гарантирует:
- Целостность данных: файл либо полностью записан, либо не существует
- Отсутствие частичных записей при сбоях
- Возможность безопасного чтения файла другими процессами

## Метаданные (meta.yaml)

Автоматически генерируемый YAML-файл содержит:

```yaml
pipeline_version: "1.0.0"
chembl_release: "33"
row_count: 12345
checksums:
  data_file: "sha256:..."
  meta_file: "sha256:..."
timestamp: "2024-01-01T00:00:00Z"
schema_version: "1.0"
```

## Манифест (run_manifest.json)

JSON-файл с путями к артефактам и метаданными:

```json
{
  "data_path": "./output/activity_run_001.csv",
  "meta_path": "./output/activity_run_001_meta.yaml",
  "manifest_path": "./output/activity_run_001_manifest.json",
  "format": "csv",
  "row_count": 12345,
  "timestamp": "2024-01-01T00:00:00Z"
}
```

## QC-отчёты

При необходимости генерируются отчёты о качестве данных:
- `quality_report_table.csv` — отчёт о качестве данных
- `correlation_report_table.csv` — отчёт о корреляциях

## Related Components

- **RunArtifacts**: объект с путями к артефактам
- **WriteResult**: результат операции записи
- **ActivityWriter**: использует UnifiedOutputWriter для записи результатов (см. `docs/02-pipelines/chembl/activity/03-activity-chembl-write.md`)
- **SchemaRegistry**: используется для валидации данных перед записью (см. `docs/02-pipelines/05-schema-registry.md`)

