# Testing Strategy

Стратегия тестирования BioETL направлена на обеспечение надежности и детерминизма.

## Уровни тестирования

### 1. Unit Tests
Изолированная проверка компонентов. Внешние вызовы (сеть, диск) должны быть замоканы (mocked).
- **Клиенты**: Проверка логики построения запросов и парсинга ответов.
- **Трансформеры**: Проверка логики очистки и преобразования данных.

### 2. Integration Tests
Проверка взаимодействия компонентов (например, Pipeline + Client + Writer) на реальных, но ограниченных данных (1-2 записи).
- Требуют наличия `POLYJUICE_SECRETS` (если нужен доступ к API).
- Запускаются реже (например, перед merge).

### 3. Golden Tests (Snapshot Tests)
Проверка того, что выходные данные **бит-в-бит** соответствуют эталону ("золотому" файлу).
Это критично для гарантии детерминизма. Если изменение кода меняет выходной файл, тест падает, требуя ручного подтверждения изменений (обновления golden-файла).

## Покрытие кода
Минимальный порог покрытия (Code Coverage) — **85%**.
CI блокирует Pull Request, если покрытие падает ниже этого уровня.

## Пример Golden-теста

```python
def test_activity_output_matches_golden(tmp_path):
    # 1. Запуск пайплайна с фиксированным сидом
    pipeline.run(output_path=tmp_path)
    
    # 2. Сравнение результата с эталоном
    result_df = pd.read_csv(tmp_path / "activity.csv")
    golden_df = pd.read_csv("tests/golden/activity.csv")
    
    pd.testing.assert_frame_equal(result_df, golden_df)
```

