# ETL Layers

Архитектура BioETL разделена на 6 функциональных слоев. Каждый слой имеет свои обязанности и набор ABC-интерфейсов.

## 1. Orchestration Layer (Оркестрация)

Этот слой отвечает за управление жизненным циклом пайплайна, последовательностью выполнения стадий и обработку команд CLI.

### Компоненты
- **`PipelineBase`**: Базовый абстрактный класс. Определяет скелет алгоритма: `extract` → `transform` → `validate` → `write`.
- **`PipelineRuntimeBase`**: Обеспечивает runtime-выполнение через `StageDescriptor`, управляет контекстом выполнения.
- **`ChemblPipelineBase`**: Специализация для ChEMBL, внедряет `ChemblExtractionService`.

### Ответственность
- Инициализация конфигурации и ресурсов.
- Запуск стадий в правильном порядке.
- Управление режимом `dry_run`.
- Обработка глобальных ошибок.

## 2. Monitoring Layer (Мониторинг)

Обеспечивает наблюдаемость (observability) работы системы.

### Компоненты
- **`PipelineHookABC`**: Интерфейс для хуков (`on_stage_start`, `on_stage_end`, `on_error`).
- **`LoggerAdapterABC`** (`UnifiedLogger`): Структурированное логирование событий.
- **`ProgressReporterABC`**: Отображение прогресса выполнения (tqdm или аналоги).
- **`TracerABC`**: Инструментарий для распределенной трассировки (OpenTelemetry).
- **`ErrorPolicyABC`**: Политики реакции на ошибки (fail-fast, skip, retry).

## 3. Data Access Layer (Доступ к данным)

Слой абстрагирует работу с внешними источниками данных (REST API).

### Компоненты
- **`SourceClientABC`**: Контракт клиента (`fetch_one`, `fetch_many`, `iter_pages`).
- **`RequestBuilderABC`**: Паттерн Builder для создания HTTP-запросов из бизнес-параметров.
- **`ResponseParserABC`**: Преобразование сырых ответов (JSON/XML) в список записей (`Record`).
- **`PaginatorABC`**: Стратегии пагинации (offset/limit, cursor, page/size).
- **`RateLimiterABC`**: Ограничение частоты запросов (Token Bucket).
- **`RetryPolicyABC`**: Стратегии повторных попыток с exponential backoff.
- **`CacheABC`**: Кэширование ответов API.

## 4. Transformation Layer (Трансформация)

Слой бизнес-логики, отвечающий за приведение данных к целевому виду.

### Компоненты
- **`TransformerABC`**: Интерфейс чистых функций трансформации DataFrame.
- **`LookupEnricherABC`**: Обогащение данных с использованием внешних справочников (join).
- **`BusinessKeyDeriverABC`**: Вычисление суррогатных и бизнес-ключей.
- **`DeduplicatorABC`**: Логика поиска и устранения дубликатов.
- **`MergeStrategyABC`**: Правила слияния конфликтующих записей.
- **`HasherABC`**: Детерминированное хеширование строк (`hash_row`).

## 5. Schema & Validation Layer (Схемы и валидация)

Обеспечивает качество данных и соответствие контрактам перед записью.

### Компоненты
- **Pandera Schemas**: Декларативное описание схем таблиц (`ActivitySchema`, `AssaySchema`).
- **`ValidatorABC`**: Интерфейс валидатора, запускающего проверки.
- **`SchemaProviderABC`**: Провайдер, предоставляющий схемы по имени сущности.
- **`SchemaRegistry`**: Реестр, хранящий метаданные схем (порядок колонок, ключи).

## 6. Output Layer (Вывод данных)

Отвечает за сохранение результатов на диск.

### Компоненты
- **`WriterABC`**: Интерфейс записи DataFrame в файл (CSV, Parquet).
- **`MetadataWriterABC`**: Запись метаданных прогона (`meta.yaml`) и QC-отчетов.
- **`UnifiedOutputWriter`**: Фасад, координирующий запись данных и артефактов.

### Особенности
- **Атомарная запись**: Использование паттерна `write-temp-and-rename` для предотвращения повреждения данных.

