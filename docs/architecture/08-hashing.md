# Спецификация хеширования и дедупликации (v1_blake2b_256)

## Обзор
Данный документ описывает стандарт хеширования данных в BioETL для обеспечения детерминизма, дедупликации и версионирования изменений.

Версия хеширования: `v1_blake2b_256`

## Алгоритм
- **Hash Function**: BLAKE2b
- **Digest Size**: 32 bytes (256 bits)
- **Output Encoding**: Hex string (lowercase), длина 64 символа.
- **Salt**: По умолчанию отсутствует (`null`).

## Каноническая сериализация (Canonical JSON)
Перед хешированием данные должны быть сериализованы в канонический JSON формат.

### Правила:
1. **Кодировка**: UTF-8.
2. **JSON формат**:
   - Без пробелов между разделителями (`separators=(',', ':')`).
   - `ensure_ascii=False` (символы сохраняются как есть, не `\uXXXX`).
3. **Сортировка ключей**:
   - Ключи объектов **всегда** отсортированы лексикографически (recursive sort).
4. **Массивы**:
   - Порядок элементов сохраняется (важен для упорядоченных списков).
5. **Числа**:
   - Float/Decimal форматируются как `%.15g` (исключает `NaN`, `Inf`).
   - Integers сохраняются как числа.
6. **Unicode**:
   - Строки нормализуются в форму **NFC** перед сериализацией.
7. **Null/Missing**:
   - `None` -> `null`.
   - Boolean -> `true`/`false` (lowercase).
   - При формировании `hash_business_key`, отсутствующие поля считаются `null`.

### Пример

Исходный объект:
```python
{
    "b": 2.0,
    "a": "café",
    "c": [3, 1],
    "d": None
}
```

Каноническая строка (визуально):
```json
{"a":"café","b":2,"c":[3,1],"d":null}
```
*(Замечание: `2.0` форматируется как `2` по спецификации `%.15g` если дробная часть 0)*

## Хешируемые поля

### 1. Business Key Hash (`hash_business_key`)
Идентификатор бизнес-сущности. Используется для дедупликации логических записей.

- **Вход**: Список значений полей бизнес-ключа в фиксированном порядке.
- **Сериализация**: JSON array из значений.
- **Пример**:
  Fields: `["src_id", "type"]`
  Values: `{"src_id": 100, "type": "assay"}`
  Serialized: `[100,"assay"]`
  Result: `blake2b([100,"assay"])`

### 2. Row Hash (`hash_row`)
Контрольная сумма всей записи (версия строки). Используется для детекции изменений (CDC).

- **Вход**: Полная нормализованная запись (словарь), включая поле `hash_business_key`.
- **Сериализация**: Canonical JSON всего объекта.

## Реализация
Логика реализована в инфраструктурном слое: `src/bioetl/infrastructure/transform/impl/hasher.py` (класс `HasherImpl`).

Конфигурация: `configs/hashing.yaml`.

## Интеграция в пайплайн
1. **Extract**: Raw data.
2. **Transform**:
   - Normalization (types, trim, clean).
   - **Compute Hashes**:
     - `hash_business_key` = `compute_hash_business_key(row, key_fields)`
     - `hash_row` = `compute_hash_row(row)` (включает `hash_business_key`)
3. **Validate**: Проверка уникальности `hash_business_key` (если требуется).
4. **Load**: Запись с хешами + `meta.yaml` с указанием версии хеширования.
