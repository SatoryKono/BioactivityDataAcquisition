# Data Flow

Документ описывает поток данных (Data Flow) внутри стандартного ETL-пайплайна BioETL.

## Общий поток

```mermaid
graph LR
    Source[REST API] --> Extract
    Extract -->|Raw DataFrame| Transform
    Transform -->|Normalized DF| Validate
    Validate -->|Validated DF| Write
    Write --> Output[CSV/Parquet + Meta]
```

## 1. Extract (Извлечение)
**Цель:** Получить сырые данные из источника.

- **Вход:** Конфигурация пайплайна, параметры фильтрации.
- **Процесс:**
  1. Инициализация клиента (`UnifiedAPIClient`).
  2. Выполнение пагинированных запросов.
  3. Сбор страниц в батчи.
  4. Объединение батчей в единый `pandas.DataFrame`.
- **Выход:** Сырой DataFrame (колонки как в API).

## 2. Transform (Трансформация)
**Цель:** Привести данные к каноническому виду.

- **Вход:** Сырой DataFrame.
- **Процесс:**
  1. **Normalization**: Приведение имен колонок к snake_case, преобразование типов данных.
  2. **Enrichment**: Обогащение данными из других источников (например, добавление `chembl_release`).
  3. **Deduplication**: Устранение полных дубликатов.
  4. **Hashing**: Вычисление `hash_row` и `hash_business_key`.
- **Выход:** Нормализованный DataFrame.

## 3. Validate (Валидация)
**Цель:** Гарантировать соответствие данных схеме.

- **Вход:** Нормализованный DataFrame.
- **Процесс:**
  1. Получение схемы из `SchemaRegistry`.
  2. Проверка типов колонок.
  3. Проверка `nullable` ограничений.
  4. Валидация форматов значений (Regex) и диапазонов.
  5. Приведение порядка колонок к каноническому (`column_order`).
- **Выход:** Валидированный DataFrame или исключение `SchemaError`.

## 4. Write (Запись)
**Цель:** Сохранить результаты.

- **Вход:** Валидированный DataFrame, путь вывода.
- **Процесс:**
  1. Генерация метаданных (версия, timestamp).
  2. Расчет статистик качества (QC).
  3. Атомарная запись файла данных (`.tmp` -> `.csv`).
  4. Запись файлов метаданных (`meta.yaml`) и отчетов (`quality_report_table.csv`).
- **Выход:** Объект `WriteResult`.

## Хуки (Hooks)

Пайплайн поддерживает хуки для расширения логики:

- `prepare_run(options)`: Выполняется перед началом прогона. Настройка ресурсов.
- `pre_transform(df)`: Выполняется перед основной трансформацией.
- `post_transform(df)`: Выполняется после трансформации, перед валидацией.
- `finalize_run(result)`: Выполняется в конце. Очистка ресурсов, отправка метрик.

## Режим Dry Run

При запуске с флагом `--dry-run`:
1. Выполняются стадии `Extract`, `Transform`, `Validate`.
2. Стадия `Write` **пропускается** (файлы на диск не пишутся).
3. Логируется информация о том, что было бы записано (количество строк, путь).

Это позволяет безопасно тестировать логику пайплайна без побочных эффектов.

