---
id: cb06bc9f-659f-4f94-a2ed-9c6d765fe51f
---
sequenceDiagram
    classDef actorPrimary   fill:#f5f5f5,stroke:#444,stroke-width:1.5px,color:#111,font-size:22px;
    classDef actorSecondary fill:#e3e7ec,stroke:#555,stroke-width:1.2px,color:#111,font-size:18px;
    classDef actorExternal  fill:#dde7f2,stroke:#44546a,stroke-width:1.5px,color:#111,font-size:22px;
    autonumber
    participant User as CLI/User
    participant Pipe as Pipeline
    participant Hooks as PipelineHooks
    participant Extr as Extractor (Source)
    participant Trans as Transformer
    participant Val as Validator
    participant Writer as UnifiedWriter
    participant Meta as MetadataWriter

    class User,Pipe actorPrimary
    class Hooks,Trans,Val,Writer,Meta actorSecondary
    class Extr actorExternal

    User->>Pipe: run(output_path, dry_run=False)
    activate Pipe
    
    Pipe->>Pipe: Initialize RunContext
    Pipe->>Hooks: on_stage_start(\"extract\")
    
    loop For each Chunk
        Pipe->>Extr: extract() (iter_chunks)
        activate Extr
        Extr-->>Pipe: raw_chunk (DataFrame)
        deactivate Extr
        
        Pipe->>Hooks: on_stage_start(\"transform\")
        Pipe->>Trans: transform(raw_chunk)
        activate Trans
        Trans-->>Pipe: transformed_df
        deactivate Trans
        
        Pipe->>Hooks: on_stage_start(\"validate\")
        Pipe->>Val: validate(transformed_df)
        activate Val
        Val-->>Pipe: validated_df
        deactivate Val
        
        Pipe->>Pipe: Collect validated chunk
    end

    Pipe->>Hooks: on_stage_end(\"extract\")
    Pipe->>Hooks: on_stage_end(\"transform\")
    Pipe->>Hooks: on_stage_end(\"validate\")

    alt Not Dry Run
        Pipe->>Hooks: on_stage_start(\"write\")
        Pipe->>Writer: write_result(all_data, output_path)
        activate Writer
        Writer->>Writer: Stable Sort & Reorder
        Writer->>Writer: Atomic Write (.tmp -> .csv)
        Writer->>Writer: Compute Checksum
        Writer->>Meta: write_meta(meta.yaml)
        Writer-->>Pipe: WriteResult
        deactivate Writer
        Pipe->>Hooks: on_stage_end(\"write\")
    else Dry Run
        Pipe->>Pipe: Skip Write
    end

    Pipe-->>User: RunResult (Stats, Meta)
    deactivate Pipe