flowchart TD

classDef stepPrimary   fill:#f5f5f5,stroke:#444,stroke-width:1.5px,color:#111,font-size:22px;
classDef stepDecision  fill:#e6ecef,stroke:#333,stroke-width:1.5px,color:#111,font-size:22px;
classDef stepSecondary fill:#e3e7ec,stroke:#555,stroke-width:1.2px,color:#111,font-size:18px;
classDef stepTerminal  fill:#dde7f2,stroke:#44546a,stroke-width:1.5px,color:#111,font-size:22px;

Start([Start Run]):::stepPrimary --> Init[Init Context & Reset Services]:::stepSecondary
Init --> ExtractStart[Notify Extract Start]:::stepSecondary
ExtractStart --> ChunkLoop{Has Next Chunk?}:::stepDecision

ChunkLoop -- Yes --> ExtractExec[Execute extract()]:::stepPrimary
ExtractExec -- Success --> TransformStart[Notify Transform Start]:::stepSecondary
ExtractExec -- Error --> ErrHandler{Error Policy}:::stepDecision

ErrHandler -- Retry --> RetryChk{Retries Left?}:::stepDecision
RetryChk -- Yes --> ExtractExec
RetryChk -- No --> FailAction[PipelineStageError]:::stepTerminal

ErrHandler -- Skip --> LogSkip[Log Skip]:::stepSecondary
LogSkip --> ChunkLoop

ErrHandler -- Fail --> FailAction
FailAction --> EndFail([Run Failed]):::stepTerminal

TransformStart --> TransExec[Execute transform()]:::stepPrimary
TransExec -- Success --> ValidateStart[Notify Validate Start]:::stepSecondary
TransExec -- Error --> ErrHandler

ValidateStart --> ValExec[Execute validate()]:::stepPrimary
ValExec -- Success --> Accumulate[Accumulate Chunk]:::stepSecondary
ValExec -- Error --> ErrHandler

Accumulate --> ChunkLoop

ChunkLoop -- No --> NotifyEnds[Notify Stages End]:::stepSecondary
NotifyEnds --> DryRunChk{Dry Run?}:::stepDecision

DryRunChk -- No --> WriteStart[Notify Write Start]:::stepSecondary
WriteStart --> WriteExec[Execute write()]:::stepPrimary
WriteExec --> MetaGen[Generate Metadata]:::stepSecondary
MetaGen --> NotifyWriteEnd[Notify Write End]:::stepSecondary
NotifyWriteEnd --> SuccessResult([Run Success]):::stepTerminal

DryRunChk -- Yes --> DryRunMeta[Generate DryRun Metadata]:::stepSecondary
DryRunMeta --> SuccessResult

