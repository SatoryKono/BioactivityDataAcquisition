graph TD;

classDef stepPrimary   fill:#f5f5f5,stroke:#444,stroke-width:1.5px,color:#111,font-size:22px;
classDef stepDecision  fill:#e6ecef,stroke:#333,stroke-width:1.5px,color:#111,font-size:22px;
classDef stepSecondary fill:#e3e7ec,stroke:#555,stroke-width:1.2px,color:#111,font-size:18px;
classDef stepTerminal  fill:#dde7f2,stroke:#44546a,stroke-width:1.5px,color:#111,font-size:22px;

Start([Start Run]) --> Init[Init Context & Reset Services];
Init --> ExtractStart[Notify Extract Start];
ExtractStart --> ChunkLoop{Has Next Chunk?};

ChunkLoop -->|Yes| ExtractExec[Execute extract]; ExtractExec -->|Success| TransformStart[Notify Transform Start]; ExtractExec -->|Error| ErrHandler{Error Policy};

ErrHandler -->|Retry| RetryChk{Retries Left?}; RetryChk -->|Yes| ExtractExec; RetryChk -->|No| FailAction[PipelineStageError];

ErrHandler -->|Skip| LogSkip[Log Skip]; LogSkip --> ChunkLoop;

ErrHandler -->|Fail| FailAction; FailAction --> EndFail([Run Failed]);

TransformStart --> TransExec[Execute transform];
TransExec -->|Success| ValidateStart[Notify Validate Start];
TransExec -->|Error| ErrHandler;

ValidateStart --> ValExec[Execute validate];
ValExec -->|Success| Accumulate[Accumulate Chunk];
ValExec -->|Error| ErrHandler;

Accumulate --> ChunkLoop;

ChunkLoop -->|No| NotifyEnds[Notify Stages End];
NotifyEnds --> DryRunChk{Dry Run?};

DryRunChk -->|No| WriteStart[Notify Write Start];
WriteStart --> WriteExec[Execute write];
WriteExec --> MetaGen[Generate Metadata];
MetaGen --> NotifyWriteEnd[Notify Write End];
NotifyWriteEnd --> SuccessResult([Run Success]);

DryRunChk -->|Yes| DryRunMeta[Generate DryRun Metadata];
DryRunMeta --> SuccessResult;

class Start,ExtractExec,TransExec,ValExec,WriteExec stepPrimary;
class Init,ExtractStart,TransformStart,ValidateStart,Accumulate,LogSkip,NotifyEnds,WriteStart,MetaGen,NotifyWriteEnd,DryRunMeta stepSecondary;
class ChunkLoop,ErrHandler,RetryChk,DryRunChk stepDecision;
class FailAction,EndFail,SuccessResult stepTerminal;