# Duplication Reduction

Для борьбы с дублированием кода и логики в проекте BioETL применяются следующие архитектурные принципы и паттерны.

## 1. Единая точка определения (Single Source of Truth)

Каждый контракт, константа или правило должны быть определены ровно в одном месте.

- **Конфигурация**: Все параметры пайплайнов определяются в YAML и загружаются через единый `ConfigResolver`.
- **Схемы**: Структура таблиц определяется только в Pandera-схемах.
- **Версии**: Версия пайплайна и релиза ChEMBL определяются в коде и попадают в метаданные автоматически.

## 2. Трёхслойный паттерн ABC/Default/Impl

Для обеспечения гибкости и тестируемости используется строгий паттерн разделения интерфейса и реализации.

```text
Contract (ABC)          → src/bioetl/clients/<domain>/contracts.py
Default factory         → src/bioetl/clients/<domain>/factories.py
Implementation (Impl)   → src/bioetl/clients/<domain>/impl/
```

Это позволяет:
- Писать код, зависящий только от абстракций (ABC).
- Легко подменять реализации (Mock) в тестах.
- Иметь точку расширения через фабрики по умолчанию.

## 3. Иерархия пайплайнов

Вместо копирования кода `extract`/`transform`/`load` для каждой сущности используется наследование от базовых классов.

```text
PipelineBase (src/bioetl/core/pipeline_base.py)
    │
    └── ChemblPipelineBase (добавляет специфику ChEMBL)
            │
            └── ChemblCommonPipeline (src/bioetl/pipelines/chembl/common/base.py)
                    │
                    ├── ChemblActivityPipeline
                    ├── ChemblAssayPipeline
                    ├── ChemblTargetPipeline
                    └── ...
```

**ChemblCommonPipeline** инкапсулирует общую логику:
- Инициализация `ChemblExtractionService`.
- Создание дескрипторов выборки.
- Стандартная валидация и генерация QC-отчетов.

## 4. Общие сервисы и компоненты

Логика, не специфичная для конкретной сущности, вынесена в переиспользуемые компоненты:

- **`ChemblExtractionService`**: Единая логика пагинации, батчинга и скачивания данных для всех сущностей ChEMBL.
- **`ChemblRequestBuilder`**: Централизованное построение URL и параметров запросов.
- **`UnifiedOutputWriter`**: Общая логика атомарной записи, генерации checksums и метаданных.
- **`BaseChemblNormalizer`**: Базовый трансформер для общих операций очистки строк и приведения типов.

## 5. Композиция над наследованием

Там, где наследование неудобно, используется композиция. Пайплайн получает необходимые стратегии через конструктор или фабрику:

- `Paginator` внедряется в Клиент.
- `Validator` внедряется в Пайплайн.
- `Writer` внедряется в Пайплайн.

Это позволяет менять поведение компонентов (например, менять стратегию пагинации) без изменения кода пайплайна.

